<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Animal Shelter - Khairul Johari</title>
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Modern color palette */
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --orange: #f97316;

            /* Glassmorphism colors */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: rgba(255, 255, 255, 0.7);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.08);
            --shadow-hover: 0 10px 25px rgba(0,0,0,0.15);

            /* Border radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;

            --sidebar-width: 280px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app {
            display: flex;
            min-height: 100vh;
        }

        /* GLASSMORPHISM UTILITIES */
        .glass {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
            box-shadow: 4px 0 24px rgba(0,0,0,0.08);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .logo {
            padding: 28px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .logo-text h1 {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .logo-text p {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .nav-section {
            padding: 20px 12px;
        }

        .nav-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-light);
            padding: 0 12px 10px;
            font-weight: 700;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            margin: 3px 0;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.25s ease;
            color: var(--text-secondary);
            font-weight: 500;
            position: relative;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
            color: var(--primary);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            color: var(--primary);
            font-weight: 600;
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 24px;
            background: linear-gradient(180deg, var(--primary), var(--purple));
            border-radius: 0 4px 4px 0;
        }

        .nav-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* HEADER */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 18px 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 90;
            box-shadow: 0 1px 10px rgba(0,0,0,0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .menu-btn {
            display: none;
            width: 40px;
            height: 40px;
            background: rgba(99, 102, 241, 0.1);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            background: rgba(99, 102, 241, 0.2);
        }

        .search-box {
            position: relative;
            width: 320px;
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 16px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 46px;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 14px;
            background: rgba(248, 250, 252, 0.8);
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-btn {
            width: 44px;
            height: 44px;
            background: rgba(248, 250, 252, 0.8);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.25s;
            position: relative;
        }

        .header-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .notification-dot {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--secondary), var(--orange));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        /* CONTENT */
        .content {
            padding: 32px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 28px;
        }

        .section-title {
            font-size: 32px;
            font-weight: 800;
            color: white;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.85);
        }

        /* STATS CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .dashboard-graphs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .graph-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-xl);
            padding: 24px;
            box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .graph-card h3 {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .graph-card p {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 14px;
        }

        .graph-card canvas {
            width: 100% !important;
            height: 240px !important;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: var(--radius-xl);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--purple));
        }

        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-bottom: 16px;
        }

        .stat-icon.blue { background: linear-gradient(135deg, #dbeafe, #bfdbfe); }
        .stat-icon.red { background: linear-gradient(135deg, #fee2e2, #fecaca); }
        .stat-icon.green { background: linear-gradient(135deg, #d1fae5, #a7f3d0); }
        .stat-icon.purple { background: linear-gradient(135deg, #ede9fe, #ddd6fe); }

        .stat-value {
            font-size: 40px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
            line-height: 1;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* SPECIES TABS */
        .species-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .species-tabs::-webkit-scrollbar {
            height: 6px;
        }

        .species-tabs::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }

        .species-tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-weight: 700;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            white-space: nowrap;
            font-size: 14px;
        }

        .species-tab:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .species-tab.active {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            border-color: transparent;
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
        }

        /* ANIMALS GRID */
        .animals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 24px;
        }

        .animal-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.4s ease;
            cursor: pointer;
            position: relative;
        }

        .animal-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 32px rgba(0,0,0,0.2);
        }

        .animal-card.has-alert::after {
            content: '⚠️';
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 28px;
            z-index: 10;
            animation: alertPulse 2s infinite;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        @keyframes alertPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.15); opacity: 0.8; }
        }

        .animal-image-wrapper {
            position: relative;
            height: 240px;
            background: linear-gradient(135deg, #e0e7ff, #f3e8ff);
            overflow: hidden;
        }

        .animal-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s ease;
        }

        .animal-card:hover .animal-image {
            transform: scale(1.08);
        }

        .tracking-badge {
            position: absolute;
            top: 14px;
            left: 14px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            color: white;
            padding: 7px 14px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 7px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .tracking-badge.live::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: liveBlink 1.5s infinite;
            box-shadow: 0 0 8px var(--success);
        }

        @keyframes liveBlink {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.9); }
        }

        .health-badge {
            position: absolute;
            bottom: 14px;
            right: 14px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 3px solid white;
        }

        .health-badge.good { background: var(--success); }
        .health-badge.warning { background: var(--warning); }
        .health-badge.danger { background: var(--danger); }

        .animal-content {
            padding: 20px;
        }

        .animal-header {
            margin-bottom: 16px;
        }

        .animal-name {
            font-size: 22px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 4px;
            letter-spacing: -0.3px;
        }

        .animal-species {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .animal-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .stat-item {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            padding: 12px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .stat-item-label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .stat-item-value {
            font-size: 16px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .animal-devices {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .device-icon {
            font-size: 18px;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .device-icon:hover {
            transform: scale(1.15);
            background: linear-gradient(135deg, var(--primary), var(--purple));
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .animal-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        /* TRACKING MAP */
        .tracking-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-xl);
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            margin-bottom: 28px;
        }

        .tracking-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
        }

        .tracking-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tracking-filter {
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 999px;
            padding: 10px 18px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(99, 102, 241, 0.08);
            font-weight: 700;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tracking-filter.active {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            box-shadow: 0 8px 18px rgba(99, 102, 241, 0.3);
            border-color: transparent;
        }

        .filter-count {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.25);
        }

        .tracking-view-toggle {
            display: inline-flex;
            background: rgba(99, 102, 241, 0.08);
            border-radius: 999px;
            padding: 4px;
            gap: 6px;
        }

        .tracking-view-btn {
            border: none;
            background: transparent;
            padding: 8px 18px;
            border-radius: 999px;
            font-weight: 700;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tracking-view-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 6px 14px rgba(99, 102, 241, 0.2);
        }

        .tracking-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .tracking-stat-card {
            background: rgba(248, 250, 252, 0.9);
            border-radius: var(--radius-lg);
            padding: 16px 20px;
            border: 1px solid rgba(99, 102, 241, 0.1);
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.06);
        }

        .tracking-stat-card .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-light);
            font-weight: 700;
            margin-bottom: 6px;
        }

        .tracking-stat-card .stat-value {
            font-size: 32px;
            font-weight: 900;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 4px;
        }

        .tracking-stat-card .stat-meta {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .tracking-container {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 24px;
            margin-bottom: 32px;
        }

        .map-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: 24px;
            box-shadow: 0 20px 60px rgba(15, 23, 42, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.5);
            height: 580px;
            position: relative;
            overflow: hidden;
        }

        .map-card.heat-mode {
            box-shadow: 0 25px 70px rgba(99, 102, 241, 0.25);
        }

        .live-map {
            width: 100%;
            height: 100%;
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .map-card.heat-mode .live-map {
            filter: saturate(1.15) hue-rotate(-6deg) brightness(1.08);
        }

        .leaflet-container {
            background: #eef2ff;
            font-family: inherit;
        }

        .map-empty-overlay {
            position: absolute;
            inset: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            transition: opacity 0.25s ease;
        }

        .map-empty-overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .map-placeholder-card {
            padding: 24px;
            border-radius: var(--radius-xl);
            background: rgba(255, 255, 255, 0.92);
            text-align: center;
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.15);
            font-weight: 700;
            color: var(--text-secondary);
        }

        .map-pin {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--pin-color, var(--primary));
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.25);
            position: relative;
            animation: pinPulse 3s infinite;
        }

        .map-pin.resting {
            opacity: 0.85;
            animation-duration: 4s;
        }

        @keyframes pinPulse {
            0% { transform: scale(0.9); opacity: 0.85; }
            70% { transform: scale(1.3); opacity: 0; }
            100% { opacity: 0; }
        }

        .map-pin::after {
            content: attr(data-label);
            position: absolute;
            bottom: 135%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            color: white;
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
        }

        .map-pin-inner {
            font-size: 24px;
        }

        .map-legend {
            margin-top: 18px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .legend-item {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.08);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .tracking-list {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: 24px;
            box-shadow: 0 20px 60px rgba(15, 23, 42, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.5);
            overflow-y: auto;
            max-height: 580px;
            position: relative;
        }

        .tracking-list::after {
            content: '';
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(180deg, transparent, rgba(255,255,255,0.95));
            pointer-events: none;
        }

        .tracking-list h3 {
            margin-bottom: 18px;
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .tracking-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: rgba(248, 250, 252, 0.9);
            border-radius: var(--radius-lg);
            margin-bottom: 14px;
            cursor: pointer;
            transition: all 0.25s ease;
            border: 1px solid rgba(99, 102, 241, 0.08);
        }

        .tracking-item:hover {
            background: white;
            transform: translateX(6px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.15);
        }

        .tracking-avatar {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-md);
            object-fit: cover;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tracking-empty {
            padding: 26px;
            border-radius: var(--radius-lg);
            background: rgba(248, 250, 252, 0.8);
            border: 1px dashed rgba(99, 102, 241, 0.4);
            text-align: center;
            font-weight: 700;
            color: var(--text-secondary);
        }

        .tracking-info {
            flex: 1;
        }

        .tracking-name {
            font-size: 16px;
            font-weight: 800;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .tracking-location {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }

        .tracking-status {
            padding: 7px 14px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-moving {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-resting {
            background: #d1fae5;
            color: #065f46;
        }

        /* FEEDING & SCHEDULES */
        .schedule-grid {
            display: grid;
            gap: 16px;
        }

        .schedule-item {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
        }

        .schedule-item:hover {
            transform: translateX(6px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .schedule-time {
            font-size: 28px;
            font-weight: 900;
            color: var(--primary);
            min-width: 90px;
            text-align: center;
        }

        .schedule-details {
            flex: 1;
        }

        .schedule-animal {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .schedule-meal {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .schedule-status {
            padding: 10px 18px;
            border-radius: var(--radius-md);
            font-weight: 800;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-completed {
            background: #d1fae5;
            color: var(--success);
        }

        .status-pending {
            background: #fed7aa;
            color: #c2410c;
        }

        /* ENVIRONMENT ROOMS */
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .room-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 24px;
            border-radius: var(--radius-xl);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
        }

        .room-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.15);
        }

        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .room-name {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-primary);
        }

        .room-status {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor;
        }

        .room-status.good { background: var(--success); color: var(--success); }
        .room-status.warning { background: var(--warning); color: var(--warning); }
        .room-status.danger { background: var(--danger); color: var(--danger); }

        .room-metrics {
            display: grid;
            gap: 14px;
            margin-bottom: 20px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            border-radius: var(--radius-sm);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .metric-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .metric-value {
            font-size: 20px;
            font-weight: 900;
            color: var(--text-primary);
        }

        .temp-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .temp-btn {
            width: 38px;
            height: 38px;
            border: none;
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 20px;
            font-weight: 900;
            transition: all 0.25s ease;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .temp-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .temp-slider {
            flex: 1;
            height: 10px;
            background: var(--border);
            border-radius: 5px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .temp-slider-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--purple));
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        /* ALERTS */
        .alerts-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-xl);
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 15px 45px rgba(15, 23, 42, 0.12);
            margin-bottom: 24px;
        }

        .alerts-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: space-between;
            align-items: center;
        }

        .alert-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .alert-filter {
            padding: 10px 18px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            background: rgba(148, 163, 184, 0.08);
            font-weight: 700;
            color: var(--text-secondary);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .alert-filter.active {
            background: linear-gradient(135deg, var(--primary), var(--purple));
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
        }

        .alerts-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }

        .alert-summary-card {
            padding: 18px;
            border-radius: var(--radius-lg);
            background: rgba(248, 250, 252, 0.95);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
        }

        .alert-summary-card .label {
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
            color: var(--text-light);
            font-weight: 800;
            margin-bottom: 6px;
        }

        .alert-summary-card .value {
            font-size: 32px;
            font-weight: 900;
            color: var(--text-primary);
            line-height: 1;
        }

        .alert-summary-card .meta {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .alerts-grid {
            display: grid;
            gap: 18px;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--radius-xl);
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.15);
            position: relative;
            overflow: hidden;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
        }

        .alert-item::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.5), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .alert-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 25px 50px rgba(15, 23, 42, 0.2);
        }

        .alert-item.urgent::after {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.7), transparent);
        }

        .alert-item.moderate::after {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.7), transparent);
        }

        .alert-item.routine::after {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.7), transparent);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .alert-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .alert-pill.urgent { background: var(--danger); }
        .alert-pill.moderate { background: var(--warning); color: #78350f; }
        .alert-pill.routine { background: var(--primary); }

        .alert-time {
            font-size: 13px;
            color: var(--text-light);
            font-weight: 700;
        }

        .alert-message {
            font-size: 20px;
            font-weight: 800;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .alert-animal {
            font-size: 15px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 14px;
        }

        .alert-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 14px;
        }

        .alert-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            background: rgba(226, 232, 240, 0.6);
            font-weight: 700;
        }

        .alert-progress {
            height: 6px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.3);
            overflow: hidden;
        }

        .alert-progress-fill {
            height: 100%;
            border-radius: inherit;
            background: linear-gradient(90deg, var(--primary), var(--purple));
            width: var(--progress, 60%);
        }

        .alert-actions {
            margin-top: 18px;
            display: flex;
            gap: 12px;
        }

        .alert-actions .btn {
            padding: 10px 18px;
            font-size: 14px;
        }

        .alerts-empty {
            padding: 30px;
            border-radius: var(--radius-xl);
            background: rgba(248, 250, 252, 0.9);
            border: 2px dashed rgba(148, 163, 184, 0.4);
            text-align: center;
            font-weight: 700;
            color: var(--text-secondary);
        }

        /* INVENTORY */
        .inventory-grid {
            display: grid;
            gap: 16px;
        }

        .inventory-item {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px;
            border-radius: var(--radius-lg);
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .inventory-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .inventory-icon {
            width: 68px;
            height: 68px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, #dbeafe, #ede9fe);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 34px;
        }

        .inventory-details {
            flex: 1;
        }

        .inventory-name {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .inventory-category {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .inventory-stock {
            text-align: right;
        }

        .stock-level {
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .stock-status {
            font-size: 12px;
            font-weight: 800;
            padding: 5px 12px;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stock-low {
            background: #fee2e2;
            color: var(--danger);
        }

        .stock-ok {
            background: #d1fae5;
            color: var(--success);
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 24px 60px rgba(0,0,0,0.4);
            animation: modalSlideUp 0.4s ease;
        }

        @keyframes modalSlideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 28px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: start;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
        }

        .modal-title {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .modal-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(0, 0, 0, 0.05);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 24px;
            transition: all 0.25s ease;
            color: var(--text-secondary);
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 28px;
        }

        .modal-image {
            width: 100%;
            height: 320px;
            object-fit: cover;
            border-radius: var(--radius-md);
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .sensors-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .sensor-card {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            padding: 18px;
            border-radius: var(--radius-md);
            text-align: center;
            border: 1px solid rgba(99, 102, 241, 0.1);
            transition: all 0.25s ease;
        }

        .sensor-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 16px rgba(99, 102, 241, 0.15);
        }

        .sensor-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }

        .sensor-label {
            font-size: 11px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 6px;
            font-weight: 800;
        }

        .sensor-value {
            font-size: 26px;
            font-weight: 900;
            color: var(--text-primary);
        }

        .cctv-feed {
            background: #000;
            border-radius: var(--radius-md);
            height: 280px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .cctv-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 56px;
        }

        .cctv-overlay {
            position: absolute;
            top: 14px;
            left: 14px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 900;
            display: flex;
            align-items: center;
            gap: 7px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .rec-dot {
            width: 9px;
            height: 9px;
            background: white;
            border-radius: 50%;
            animation: recBlink 1s infinite;
        }

        @keyframes recBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        .notes-section {
            margin-top: 24px;
        }

        .notes-title {
            font-size: 17px;
            font-weight: 800;
            margin-bottom: 14px;
            color: var(--text-primary);
        }

        .note-item {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            padding: 14px;
            border-radius: var(--radius-sm);
            margin-bottom: 10px;
            font-size: 14px;
            border: 1px solid rgba(99, 102, 241, 0.1);
        }

        .note-time {
            font-weight: 900;
            color: var(--primary);
            margin-right: 10px;
        }

        .modal-footer {
            padding: 24px 28px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.02), rgba(139, 92, 246, 0.02));
        }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 28px;
            right: 28px;
            background: linear-gradient(135deg, var(--text-primary), #0f172a);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius-md);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            font-weight: 700;
            animation: toastSlideIn 0.3s ease;
        }

        .toast.show {
            display: block;
        }

        @keyframes toastSlideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* EMERGENCY LOCK PANEL */
        .emergency-panel {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.15));
            padding: 20px;
            border-radius: var(--radius-lg);
            border: 2px solid var(--danger);
            margin-bottom: 20px;
        }

        .emergency-title {
            font-size: 16px;
            font-weight: 900;
            color: var(--danger);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .tracking-container {
                grid-template-columns: 1fr;
            }

            .tracking-list {
                max-height: 400px;
            }
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .search-box {
                display: none;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }

            .section-title {
                font-size: 26px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .animals-grid {
                grid-template-columns: 1fr;
            }

            .rooms-grid {
                grid-template-columns: 1fr;
            }

            .header {
                padding: 14px 20px;
            }

            .header-right {
                gap: 8px;
            }

            .header-btn, .user-avatar {
                width: 38px;
                height: 38px;
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .animal-stats {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">🐾</div>
                <div class="logo-text">
                    <h1>Smart Shelter</h1>
                    <p>Khairul Johari</p>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Main</div>
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <span class="nav-icon">📊</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showSection('animals')">
                    <span class="nav-icon">🐾</span>
                    <span>Animals</span>
                </div>
                <div class="nav-item" onclick="showSection('tracking')">
                    <span class="nav-icon">📍</span>
                    <span>Live Tracking</span>
                </div>
                <div class="nav-item" onclick="showSection('alerts')">
                    <span class="nav-icon">🚨</span>
                    <span>Alerts</span>
                    <span class="nav-badge" id="alertBadge">0</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">Operations</div>
                <div class="nav-item" onclick="showSection('feeding')">
                    <span class="nav-icon">🍽️</span>
                    <span>Feeding</span>
                </div>
                <div class="nav-item" onclick="showSection('health')">
                    <span class="nav-icon">❤️</span>
                    <span>Health Monitor</span>
                </div>
                <div class="nav-item" onclick="showSection('environment')">
                    <span class="nav-icon">🌡️</span>
                    <span>Environment</span>
                </div>
                <div class="nav-item" onclick="showSection('inventory')">
                    <span class="nav-icon">📦</span>
                    <span>Inventory</span>
                    <span class="nav-badge" id="inventoryBadge">0</span>
                </div>
            </div>

            <div class="nav-section">
                <div class="nav-title">System</div>
                <div class="nav-item" onclick="showSection('reports')">
                    <span class="nav-icon">📈</span>
                    <span>Reports</span>
                </div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content" id="mainContent">
            <!-- HEADER -->
            <header class="header">
                <div class="header-left">
                    <button class="menu-btn" onclick="toggleSidebar()">☰</button>
                    <div class="search-box">
                        <span class="search-icon">🔍</span>
                        <input type="text" class="search-input" placeholder="Search animals, rooms...">
                    </div>
                </div>

                <div class="header-right">
                    <button class="header-btn">
                        🔔
                        <span class="notification-dot"></span>
                    </button>
                    <button class="header-btn">⚙️</button>
                    <div class="user-avatar">KJ</div>
                </div>
            </header>

            <!-- CONTENT -->
            <div class="content">
                <!-- DASHBOARD SECTION -->
                <section class="page-section active" id="dashboard-section">
                    <div class="section-header">
                        <h1 class="section-title">Dashboard Overview</h1>
                        <p class="section-subtitle">Real-time shelter management and monitoring</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon blue">🐾</div>
                            <div class="stat-value" id="totalAnimals">0</div>
                            <div class="stat-label">Total Animals</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon red">⚠️</div>
                            <div class="stat-value" id="needAttention">0</div>
                            <div class="stat-label">Need Attention</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon green">✅</div>
                            <div class="stat-value" id="tasksPending">0</div>
                            <div class="stat-label">Tasks Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon purple">📍</div>
                            <div class="stat-value" id="trackingActive">0</div>
                            <div class="stat-label">Tracking Active</div>
                        </div>
                    </div>

                    <div class="dashboard-graphs">
                        <div class="graph-card">
                            <h3>Species Distribution</h3>
                            <p>Population mix across the shelter</p>
                            <canvas id="speciesChart"></canvas>
                        </div>
                        <div class="graph-card">
                            <h3>Health Status</h3>
                            <p>Overall wellness for tracked animals</p>
                            <canvas id="healthStatusChart"></canvas>
                        </div>
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); padding: 28px; border-radius: var(--radius-xl); box-shadow: 0 4px 16px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.5);">
                        <h2 style="margin-bottom: 20px; font-size: 22px; font-weight: 800; color: var(--text-primary);">
                            <span style="margin-right: 8px;">🎯</span>
                            Quick Actions
                        </h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px;">
                            <button class="btn btn-primary" onclick="showSection('feeding')">📋 Feeding Schedule</button>
                            <button class="btn btn-primary" onclick="showSection('alerts')">🚨 Check Alerts</button>
                            <button class="btn btn-primary" onclick="showSection('tracking')">📍 Live Tracking</button>
                            <button class="btn btn-primary" onclick="showSection('environment')">🌡️ Room Controls</button>
                        </div>
                    </div>
                </section>

                <!-- ANIMALS SECTION -->
                <section class="page-section" id="animals-section">
                    <div class="section-header">
                        <h1 class="section-title">Animals Management</h1>
                        <p class="section-subtitle">Browse and manage all animals by species</p>
                    </div>

                    <div class="species-tabs">
                        <div class="species-tab active" onclick="filterSpecies('Goat')">🐐 Goats</div>
                        <div class="species-tab" onclick="filterSpecies('Sugarglider')">🐿️ Sugar Gliders</div>
                        <div class="species-tab" onclick="filterSpecies('Alligator')">🐊 Alligators</div>
                        <div class="species-tab" onclick="filterSpecies('Snail')">🐌 Snails</div>
                        <div class="species-tab" onclick="filterSpecies('Porcupine')">🦔 Porcupines</div>
                        <div class="species-tab" onclick="filterSpecies('Fox')">🦊 Foxes</div>
                    </div>

                    <div class="animals-grid" id="animalsGrid"></div>
                </section>

                <!-- TRACKING SECTION -->
                <section class="page-section" id="tracking-section">
                    <div class="section-header">
                        <h1 class="section-title">Live Animal Tracking</h1>
                        <p class="section-subtitle">Real-time GPS tracking with automatic position updates</p>
                    </div>

                    <div class="tracking-panel">
                        <div class="tracking-toolbar" id="trackingToolbar"></div>
                        <div class="tracking-stats" id="trackingStats"></div>
                    </div>

                    <div class="tracking-container">
                        <div class="map-card" id="mapCard">
                            <div class="live-map" id="trackingMap"></div>
                            <div class="map-empty-overlay hidden" id="mapEmptyState">
                                <div class="map-placeholder-card">
                                    🛰️ No live trackers yet.<br>
                                    Enable a species filter to populate the map.
                            </div>
                            </div>
                            <div class="map-legend" id="trackingLegend"></div>
                        </div>

                        <div class="tracking-list">
                            <h3>Tracked Animals (<span id="trackedCount">0</span>)</h3>
                            <div id="trackingList"></div>
                        </div>
                    </div>
                </section>

                <!-- FEEDING SECTION -->
                <section class="page-section" id="feeding-section">
                    <div class="section-header">
                        <h1 class="section-title">Feeding Schedule</h1>
                        <p class="section-subtitle">Today's feeding times and meal plans</p>
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); padding: 24px; border-radius: var(--radius-xl); box-shadow: 0 4px 16px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.5);">
                        <div class="schedule-grid" id="feedingSchedule"></div>
                    </div>
                </section>

                <!-- ALERTS SECTION -->
                <section class="page-section" id="alerts-section">
                    <div class="section-header">
                        <h1 class="section-title">Alerts & Notifications</h1>
                        <p class="section-subtitle">Critical alerts and system notifications</p>
                    </div>

                    <div class="alerts-panel">
                        <div class="alerts-toolbar" id="alertsToolbar"></div>
                        <div class="alerts-summary" id="alertsSummary"></div>
                    </div>

                    <div class="alerts-grid" id="alertsGrid"></div>
                </section>

                <!-- ENVIRONMENT SECTION -->
                <section class="page-section" id="environment-section">
                    <div class="section-header">
                        <h1 class="section-title">Environment Control</h1>
                        <p class="section-subtitle">Monitor and control room conditions</p>
                    </div>

                    <div class="rooms-grid" id="roomsGrid"></div>
                </section>

                <!-- INVENTORY SECTION -->
                <section class="page-section" id="inventory-section">
                    <div class="section-header">
                        <h1 class="section-title">Inventory Management</h1>
                        <p class="section-subtitle">Track supplies and stock levels</p>
                    </div>

                    <div class="inventory-grid" id="inventoryGrid"></div>
                </section>

                <!-- HEALTH SECTION -->
                <section class="page-section" id="health-section">
                    <div class="section-header">
                        <h1 class="section-title">Health Monitoring</h1>
                        <p class="section-subtitle">Real-time health metrics and alerts</p>
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); padding: 28px; border-radius: var(--radius-xl); box-shadow: 0 4px 16px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.5);">
                        <h3 style="margin-bottom: 20px; font-size: 20px; font-weight: 800; color: var(--text-primary);">💉 Vaccination Schedule</h3>
                        <div class="schedule-grid">
                            <div class="schedule-item">
                                <div class="schedule-time">🩺</div>
                                <div class="schedule-details">
                                    <div class="schedule-animal">Foxes - Rabies Vaccine</div>
                                    <div class="schedule-meal">Due: Next week</div>
                                </div>
                                <div class="schedule-status status-pending">Upcoming</div>
                            </div>
                            <div class="schedule-item">
                                <div class="schedule-time">💊</div>
                                <div class="schedule-details">
                                    <div class="schedule-animal">Nanny - Antibiotics</div>
                                    <div class="schedule-meal">Twice daily for 5 days</div>
                                </div>
                                <div class="schedule-status status-pending">Active</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- REPORTS SECTION -->
                <section class="page-section" id="reports-section">
                    <div class="section-header">
                        <h1 class="section-title">Reports & Analytics</h1>
                        <p class="section-subtitle">Performance metrics and trends</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">98%</div>
                            <div class="stat-label">Feeding Compliance</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">95%</div>
                            <div class="stat-label">Health Score</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">24</div>
                            <div class="stat-label">CCTV Cameras</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">100%</div>
                            <div class="stat-label">System Uptime</div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- ANIMAL DETAIL MODAL -->
    <div class="modal" id="animalModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="modalTitle">Animal Name</div>
                    <div class="modal-subtitle" id="modalSubtitle">Species</div>
                </div>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>

            <div class="modal-body">
                <img src="" id="modalImage" class="modal-image" alt="Animal">

                <div id="emergencyPanel"></div>

                <div class="cctv-feed" id="cctvFeed">
                    <div class="cctv-placeholder">📹</div>
                    <div class="cctv-overlay">
                        <span class="rec-dot"></span>
                        <span>LIVE</span>
                    </div>
                </div>

                <div class="sensors-grid" id="modalSensors"></div>

                <div class="notes-section">
                    <h3 class="notes-title">📝 Recent Activity</h3>
                    <div id="modalNotes"></div>
                </div>
            </div>

            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-success" onclick="feedAnimal()">🍽️ Feed Now</button>
                <button class="btn btn-primary" onclick="showSection('tracking'); closeModal();">📍 Track Location</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
        // Tracking cluster centers keep species grouped
        const trackingClusters = {
            Goat: { lat: 3.1131, lng: 101.7898, radius: 0.0004 },
            'Red Fox': { lat: 3.1146, lng: 101.7909, radius: 0.00035 },
            Porcupine: { lat: 3.1158, lng: 101.7929, radius: 0.0003 },
            Alligator: { lat: 3.1167, lng: 101.7951, radius: 0.00025 }
        };

        // Enhanced animal database with species-specific requirements matching the full draft
        const animalDatabase = {
            Goat: [
                {
                    id: 1,
                    name: 'Jebat',
                    species: 'Goat',
                    images: [
                        'images/goat/Jebat.jpg'
                    ],
                    health: 'good',
                    lastFed: '1h ago',
                    sensors: {
                        heartRate: { value: 74, unit: 'bpm', icon: '❤️', label: 'Heart Rate' },
                        temp: { value: 38.4, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        activity: { value: 'Active', unit: '', icon: '📊', label: 'Activity' },
                        airQuality: { value: 44, unit: 'AQI', icon: '🌬️', label: 'Air Quality' },
                        weight: { value: 44, unit: 'kg', icon: '⚖️', label: 'Weight' }
                    },
                    tracking: {
                        enabled: true,
                        lat: trackingClusters.Goat.lat + 0.0001,
                        lng: trackingClusters.Goat.lng - 0.0002,
                        center: { ...trackingClusters.Goat },
                        radius: trackingClusters.Goat.radius,
                        location: 'East Pasture',
                        status: 'moving'
                    },
                    cctv: true,
                    alerts: [],
                    notes: [
                        { time: '09:00', text: 'Morning feeding completed, excellent appetite' },
                        { time: '10:15', text: 'Joined herd enrichment session' }
                    ]
                },
                {
                    id: 2,
                    name: 'Puteh',
                    species: 'Goat',
                    images: [
                        'images/goat/Puteh.jpg'
                    ],
                    health: 'warning',
                    lastFed: '4h ago',
                    sensors: {
                        heartRate: { value: 83, unit: 'bpm', icon: '❤️', label: 'Heart Rate' },
                        temp: { value: 39.1, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        activity: { value: 'Low', unit: '', icon: '📊', label: 'Activity' },
                        airQuality: { value: 43, unit: 'AQI', icon: '🌬️', label: 'Air Quality' },
                        weight: { value: 39, unit: 'kg', icon: '⚖️', label: 'Weight' }
                    },
                    tracking: {
                        enabled: true,
                        lat: trackingClusters.Goat.lat + 0.0005,
                        lng: trackingClusters.Goat.lng + 0.0003,
                        center: { ...trackingClusters.Goat },
                        radius: trackingClusters.Goat.radius,
                        location: 'East Pasture',
                        status: 'resting'
                    },
                    cctv: true,
                    alerts: ['Decreased appetite - Monitor closely'],
                    notes: [
                        { time: '08:00', text: 'Slight decrease in appetite, vet notified' },
                        { time: '11:00', text: 'Started antibiotic treatment' }
                    ]
                },
                {
                    id: 3,
                    name: 'Leman',
                    species: 'Goat',
                    images: [
                        'images/goat/Leman.jpg'
                    ],
                    health: 'good',
                    lastFed: '3h ago',
                    sensors: {
                        heartRate: { value: 78, unit: 'bpm', icon: '❤️', label: 'Heart Rate' },
                        temp: { value: 38.6, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        activity: { value: 'Grazing', unit: '', icon: '📊', label: 'Activity' },
                        airQuality: { value: 41, unit: 'AQI', icon: '🌬️', label: 'Air Quality' },
                        weight: { value: 47, unit: 'kg', icon: '⚖️', label: 'Weight' }
                    },
                    tracking: {
                        enabled: true,
                        lat: trackingClusters.Goat.lat - 0.00015,
                        lng: trackingClusters.Goat.lng - 0.0004,
                        center: { ...trackingClusters.Goat },
                        radius: trackingClusters.Goat.radius,
                        location: 'West Pasture',
                        status: 'moving'
                    },
                    cctv: true,
                    alerts: [],
                    notes: [
                        { time: '07:30', text: 'Completed morning health check' },
                        { time: '10:45', text: 'Led herd to shaded area' }
                    ]
                }
            ],
            Sugarglider: [
                {
                    id: 4,
                    name: 'Mimi',
                    species: 'Sugar Glider',
                    images: [
                        'images/sugarglider/Mimi.jpg'
                    ],
                    health: 'good',
                    lastFed: '2h ago',
                    sensors: {
                        temp: { value: 24.5, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        humidity: { value: 61, unit: '%', icon: '💧', label: 'Humidity' },
                        activity: { value: 'Nocturnal', unit: '', icon: '🌙', label: 'Activity' },
                        lightLevel: { value: 'Low', unit: '', icon: '💡', label: 'Light Level' }
                    },
                    tracking: { enabled: false },
                    cctv: false,
                    alerts: [],
                    notes: [
                        { time: '20:00', text: 'Climbed enrichment branches' },
                        { time: '22:30', text: 'Consumed nectar blend' }
                    ]
                },
                {
                    id: 5,
                    name: 'Cici',
                    species: 'Sugar Glider',
                    images: [
                        'images/sugarglider/Cici.jpg'
                    ],
                    health: 'good',
                    lastFed: '1h ago',
                    sensors: {
                        temp: { value: 24.1, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        humidity: { value: 63, unit: '%', icon: '💧', label: 'Humidity' },
                        activity: { value: 'Active', unit: '', icon: '🌙', label: 'Activity' },
                        lightLevel: { value: 'Dim', unit: '', icon: '💡', label: 'Light Level' }
                    },
                    tracking: { enabled: false },
                    cctv: false,
                    alerts: [],
                    notes: [
                        { time: '21:00', text: 'Glided between perches, good coordination' }
                    ]
                },
                {
                    id: 6,
                    name: 'Miki',
                    species: 'Sugar Glider',
                    images: [
                        'images/sugarglider/Miki.jpg'
                    ],
                    health: 'good',
                    lastFed: '3h ago',
                    sensors: {
                        temp: { value: 24.8, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        humidity: { value: 60, unit: '%', icon: '💧', label: 'Humidity' },
                        activity: { value: 'Calm', unit: '', icon: '🌙', label: 'Activity' },
                        lightLevel: { value: 'Low', unit: '', icon: '💡', label: 'Light Level' }
                    },
                    tracking: { enabled: false },
                    cctv: false,
                    alerts: [],
                    notes: [
                        { time: '19:30', text: 'Bonding pouch session completed' },
                        { time: '23:00', text: 'Finished fruit mix' }
                    ]
                }
            ],
            Alligator: [
                {
                    id: 7,
                    name: 'Awang',
                    species: 'Alligator',
                    images: [
                        'images/alligators/Awang.jpg'
                    ],
                    health: 'good',
                    lastFed: '1 day ago',
                    sensors: {
                        baskingTemp: { value: 32, unit: '°C', icon: '☀️', label: 'Basking Temp' },
                        waterTemp: { value: 26, unit: '°C', icon: '🌊', label: 'Water Temp' },
                        humidity: { value: 75, unit: '%', icon: '💧', label: 'Humidity' },
                        waterPH: { value: 7.2, unit: 'pH', icon: '⚗️', label: 'Water pH' },
                        lockStatus: { value: 'Secured', unit: '', icon: '🔒', label: 'Lock Status' }
                    },
                    tracking: {
                        enabled: true,
                        lat: trackingClusters.Alligator.lat - 0.0004,
                        lng: trackingClusters.Alligator.lng - 0.0003,
                        center: { ...trackingClusters.Alligator },
                        radius: trackingClusters.Alligator.radius,
                        location: 'Marsh Basin',
                        status: 'moving'
                    },
                    cctv: true,
                    safety: true,
                    alerts: [],
                    notes: [
                        { time: 'Yesterday', text: 'Fed whole chicken, normal appetite' },
                        { time: '10:00', text: 'Basking behavior observed' }
                    ]
                },
                {
                    id: 8,
                    name: 'Sulong',
                    species: 'Alligator',
                    images: [
                        'images/alligators/Sulong.jpg'
                    ],
                    health: 'warning',
                    lastFed: '3 days ago',
                    sensors: {
                        baskingTemp: { value: 30, unit: '°C', icon: '☀️', label: 'Basking Temp' },
                        waterTemp: { value: 24, unit: '°C', icon: '🌊', label: 'Water Temp' },
                        humidity: { value: 72, unit: '%', icon: '💧', label: 'Humidity' },
                        waterPH: { value: 7.0, unit: 'pH', icon: '⚗️', label: 'Water pH' },
                        lockStatus: { value: 'Secured', unit: '', icon: '🔒', label: 'Lock Status' }
                    },
                    tracking: {
                        enabled: true,
                        lat: trackingClusters.Alligator.lat + 0.0002,
                        lng: trackingClusters.Alligator.lng - 0.0001,
                        center: { ...trackingClusters.Alligator },
                        radius: trackingClusters.Alligator.radius,
                        location: 'South Wetlands',
                        status: 'resting'
                    },
                    cctv: true,
                    safety: true,
                    alerts: ['Refused food for 3 days - Vet consultation required'],
                    notes: [
                        { time: '3 days ago', text: 'Refused food, monitoring closely' },
                        { time: 'Today', text: 'Vet scheduled for tomorrow' }
                    ]
                }
            ],
            Snail: [
                {
                    id: 9,
                    name: 'Mondok',
                    species: 'Giant Snail',
                    images: [
                        'images/snail/Mondok.jpg'
                    ],
                    health: 'good',
                    lastFed: '10h ago',
                    sensors: {
                        humidity: { value: 86, unit: '%', icon: '💧', label: 'Humidity' },
                        temp: { value: 22, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        substrate: { value: 'Moist', unit: '', icon: '🪨', label: 'Substrate' }
                    },
                    tracking: { enabled: false },
                    cctv: false,
                    alerts: [],
                    notes: [
                        { time: 'Last night', text: 'Consumed lettuce and vegetables' }
                    ]
                },
                {
                    id: 10,
                    name: 'Koko',
                    species: 'Giant Snail',
                    images: [
                        'images/snail/Koko.jpg'
                    ],
                    health: 'good',
                    lastFed: '8h ago',
                    sensors: {
                        humidity: { value: 84, unit: '%', icon: '💧', label: 'Humidity' },
                        temp: { value: 21, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        substrate: { value: 'Even', unit: '', icon: '🪨', label: 'Substrate' }
                    },
                    tracking: { enabled: false },
                    cctv: false,
                    alerts: [],
                    notes: [
                        { time: 'Morning', text: 'Replenished calcium source' }
                    ]
                },
                {
                    id: 11,
                    name: 'Tutu',
                    species: 'Giant Snail',
                    images: [
                        'images/snail/Tutu.jpg'
                    ],
                    health: 'good',
                    lastFed: '6h ago',
                    sensors: {
                        humidity: { value: 88, unit: '%', icon: '💧', label: 'Humidity' },
                        temp: { value: 22, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        substrate: { value: 'Fresh moss', unit: '', icon: '🪨', label: 'Substrate' }
                    },
                    tracking: { enabled: false },
                    cctv: false,
                    alerts: [],
                    notes: [
                        { time: 'Afternoon', text: 'Observed eggshell strengthening exercise' }
                    ]
                }
            ],
            Porcupine: [
                {
                    id: 12,
                    name: 'Togo',
                    species: 'Porcupine',
                    images: [
                        'images/porcupine/Togo.jpg'
                    ],
                    health: 'good',
                    lastFed: '3h ago',
                    sensors: {
                        heartRate: { value: 84, unit: 'bpm', icon: '❤️', label: 'Heart Rate' },
                        temp: { value: 37.1, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        activity: { value: 'Active', unit: '', icon: '📊', label: 'Activity' },
                        enrichment: { value: 'Used', unit: '', icon: '🎾', label: 'Enrichment' }
                    },
                    tracking: {
                        enabled: true,
                        lat: trackingClusters.Porcupine.lat + 0.00012,
                        lng: trackingClusters.Porcupine.lng - 0.00015,
                        center: { ...trackingClusters.Porcupine },
                        radius: trackingClusters.Porcupine.radius,
                        location: 'Central Area',
                        status: 'moving'
                    },
                    cctv: true,
                    alerts: [],
                    notes: [
                        { time: '08:00', text: 'Enjoyed vegetables and chew toys' },
                        { time: '12:00', text: 'Active exploration behavior' }
                    ]
                },
                {
                    id: 13,
                    name: 'Dodo',
                    species: 'Porcupine',
                    images: [
                        'images/porcupine/Dodo.jpg'
                    ],
                    health: 'warning',
                    lastFed: '7h ago',
                    sensors: {
                        heartRate: { value: 90, unit: 'bpm', icon: '❤️', label: 'Heart Rate' },
                        temp: { value: 38.1, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        activity: { value: 'Low', unit: '', icon: '📊', label: 'Activity' },
                        enrichment: { value: 'Unused', unit: '', icon: '🎾', label: 'Enrichment' }
                    },
                    tracking: {
                        enabled: true,
                        lat: trackingClusters.Porcupine.lat,
                        lng: trackingClusters.Porcupine.lng + 0.00018,
                        center: { ...trackingClusters.Porcupine },
                        radius: trackingClusters.Porcupine.radius,
                        location: 'Central Area',
                        status: 'resting'
                    },
                    cctv: true,
                    alerts: ['Reduced enrichment usage - schedule play session'],
                    notes: [
                        { time: '11:30', text: 'Encouraged to explore new puzzle feeder' }
                    ]
                },
                {
                    id: 14,
                    name: 'Odin',
                    species: 'Porcupine',
                    images: [
                        'images/porcupine/Odin.jpg'
                    ],
                    health: 'danger',
                    lastFed: '9h ago',
                    sensors: {
                        heartRate: { value: 96, unit: 'bpm', icon: '❤️', label: 'Heart Rate' },
                        temp: { value: 38.6, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        activity: { value: 'Minimal', unit: '', icon: '📊', label: 'Activity' },
                        enrichment: { value: 'Unused', unit: '', icon: '🎾', label: 'Enrichment' }
                    },
                    tracking: {
                        enabled: true,
                        lat: trackingClusters.Porcupine.lat - 0.0002,
                        lng: trackingClusters.Porcupine.lng + 0.00025,
                        center: { ...trackingClusters.Porcupine },
                        radius: trackingClusters.Porcupine.radius,
                        location: 'Central Area',
                        status: 'resting'
                    },
                    cctv: true,
                    alerts: ['Elevated temperature (38.6°C) - Vet notified'],
                    notes: [
                        { time: '12:00', text: 'Elevated temp detected - vet notified' },
                        { time: '14:00', text: 'Monitoring closely, treatment started' }
                    ]
                }
            ],
            Fox: [
                {
                    id: 15,
                    name: 'Pandan',
                    species: 'Red Fox',
                    images: [
                        'images/fox/Pandan.jpg'
                    ],
                    health: 'good',
                    lastFed: '6h ago',
                    sensors: {
                        heartRate: { value: 120, unit: 'bpm', icon: '❤️', label: 'Heart Rate' },
                        temp: { value: 38.7, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        activity: { value: 'High', unit: '', icon: '📊', label: 'Activity' },
                        perimeterStatus: { value: 'Secure', unit: '', icon: '🔒', label: 'Perimeter' },
                        weight: { value: 6.3, unit: 'kg', icon: '⚖️', label: 'Weight' }
                    },
                    tracking: {
                        enabled: true,
                        lat: trackingClusters['Red Fox'].lat - 0.0006,
                        lng: trackingClusters['Red Fox'].lng - 0.0002,
                        center: { ...trackingClusters['Red Fox'] },
                        radius: trackingClusters['Red Fox'].radius,
                        location: 'North Enclosure',
                        status: 'moving'
                    },
                    cctv: true,
                    safety: true,
                    alerts: [],
                    notes: [
                        { time: '07:00', text: 'Morning hunt simulation completed' },
                        { time: '09:00', text: 'High energy levels, enrichment provided' }
                    ]
                },
                {
                    id: 16,
                    name: 'Jebat',
                    species: 'Red Fox',
                    images: [
                        'images/fox/Jebat.jpg'
                    ],
                    health: 'good',
                    lastFed: '6h ago',
                    sensors: {
                        heartRate: { value: 115, unit: 'bpm', icon: '❤️', label: 'Heart Rate' },
                        temp: { value: 38.4, unit: '°C', icon: '🌡️', label: 'Temperature' },
                        activity: { value: 'Active', unit: '', icon: '📊', label: 'Activity' },
                        perimeterStatus: { value: 'Secure', unit: '', icon: '🔒', label: 'Perimeter' },
                        weight: { value: 5.9, unit: 'kg', icon: '⚖️', label: 'Weight' }
                    },
                    tracking: {
                        enabled: true,
                        lat: trackingClusters['Red Fox'].lat + 0.00035,
                        lng: trackingClusters['Red Fox'].lng + 0.0001,
                        center: { ...trackingClusters['Red Fox'] },
                        radius: trackingClusters['Red Fox'].radius,
                        location: 'North Enclosure',
                        status: 'moving'
                    },
                    cctv: true,
                    safety: true,
                    alerts: [],
                    notes: [
                        { time: '06:30', text: 'Early morning activity observed' },
                        { time: '08:00', text: 'Fed raw meat with vitamins' }
                    ]
                }
            ]
        };

        const feedingSchedule = [
            { time: '06:00', animal: 'Foxes', meal: 'Raw meat + vitamins', status: 'completed', icon: '🦊' },
            { time: '08:00', animal: 'Goats', meal: 'Hay + grain mix', status: 'completed', icon: '🐐' },
            { time: '10:00', animal: 'Porcupines', meal: 'Vegetables + fruits', status: 'pending', icon: '🦔' },
            { time: '14:00', animal: 'Sugar Gliders', meal: 'Nectar blend', status: 'pending', icon: '🐿️' },
            { time: '18:00', animal: 'Alligators', meal: 'Whole fish (supervised)', status: 'pending', icon: '🐊' },
            { time: '22:00', animal: 'Snails', meal: 'Fresh vegetables', status: 'pending', icon: '🐌' }
        ];

        const rooms = [
            { id: 1, name: 'Goat Enclosure', temp: 22, humidity: 55, aqi: 45, status: 'good', target: 22 },
            { id: 2, name: 'Sugar Glider Room', temp: 24, humidity: 60, aqi: 40, status: 'good', target: 24 },
            { id: 3, name: 'Alligator Pool', temp: 28, humidity: 80, aqi: 50, status: 'good', target: 28 },
            { id: 4, name: 'Porcupine Habitat', temp: 20, humidity: 50, aqi: 55, status: 'warning', target: 22 },
            { id: 5, name: 'Fox Enclosure', temp: 18, humidity: 45, aqi: 42, status: 'good', target: 18 },
            { id: 6, name: 'Snail Terrarium', temp: 22, humidity: 85, aqi: 38, status: 'good', target: 22 }
        ];

        const inventory = [
            { name: 'Hay Bales', category: 'Feed', stock: 45, min: 20, icon: '🌾' },
            { name: 'Raw Meat', category: 'Feed', stock: 15, min: 20, icon: '🍖' },
            { name: 'Vegetables', category: 'Feed', stock: 8, min: 15, icon: '🥬' },
            { name: 'Medical Supplies', category: 'Health', stock: 25, min: 30, icon: '💊' },
            { name: 'Nectar Blend', category: 'Feed', stock: 12, min: 10, icon: '🍯' },
            { name: 'Enrichment Toys', category: 'Equipment', stock: 18, min: 15, icon: '🎾' }
        ];

        const trackingSpeciesMeta = {
            Goat: { label: 'Goats', icon: '🐐', color: '#f97316' },
            'Red Fox': { label: 'Foxes', icon: '🦊', color: '#ec4899' },
            Porcupine: { label: 'Porcupines', icon: '🦔', color: '#0ea5e9' },
            Alligator: { label: 'Alligators', icon: '🐊', color: '#22d3ee' }
        };

        const severityMeta = {
            urgent: { label: 'Urgent', icon: '⚡', progress: '90%' },
            moderate: { label: 'Moderate', icon: '⚠️', progress: '65%' },
            routine: { label: 'Routine', icon: '📘', progress: '40%' }
        };

        let currentSpecies = 'Goat';
        let selectedAnimal = null;
        let trackingUpdateInterval = null;
        let trackingFilters = new Set(Object.keys(trackingSpeciesMeta));
        let trackingViewMode = 'map';
        let alertFilters = new Set(Object.keys(severityMeta));
        let mapInstance = null;
        let markerLayer = null;
        const markerMap = new Map();
        let mapNeedsFit = true;
        let speciesChartInstance = null;
        let healthStatusChartInstance = null;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

        function initializeApp() {
            updateDashboardStats();
            renderAnimals();
            renderFeeding();
            renderRooms();
            renderInventory();
            renderAlerts();
            renderTrackingToolbar();
            initializeMap();
            renderTracking();
            startTrackingSimulation();
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            const allAnimals = Object.values(animalDatabase).flat();
            const needAttention = allAnimals.filter(a => a.health === 'warning' || a.health === 'danger' || a.alerts.length > 0).length;
            const trackingActive = allAnimals.filter(a => a.tracking.enabled).length;
            const pendingTasks = feedingSchedule.filter(f => f.status === 'pending').length;

            document.getElementById('totalAnimals').textContent = allAnimals.length;
            document.getElementById('needAttention').textContent = needAttention;
            document.getElementById('tasksPending').textContent = pendingTasks;
            document.getElementById('trackingActive').textContent = trackingActive;

            // Update badges
            const totalAlerts = allAnimals.reduce((sum, a) => sum + a.alerts.length, 0);
            document.getElementById('alertBadge').textContent = totalAlerts;

            const lowStock = inventory.filter(i => i.stock < i.min).length;
            document.getElementById('inventoryBadge').textContent = lowStock;

            renderSpeciesChart(allAnimals);
            renderHealthStatusChart(allAnimals);
        }

        function renderSpeciesChart(allAnimals) {
            const canvas = document.getElementById('speciesChart');
            if (!canvas || !window.Chart) return;

            const counts = {};
            allAnimals.forEach(animal => {
                counts[animal.species] = (counts[animal.species] || 0) + 1;
            });

            const labels = Object.keys(counts);
            const data = labels.map(label => counts[label]);
            const colors = labels.map(label => trackingSpeciesMeta[label]?.color || '#6366f1');

            if (speciesChartInstance) speciesChartInstance.destroy();
            speciesChartInstance = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Animals',
                        data,
                        backgroundColor: colors,
                        borderRadius: 12,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8', stepSize: 1 },
                            grid: { color: 'rgba(148, 163, 184, 0.3)', drawBorder: false }
                        },
                        x: {
                            ticks: { color: '#64748b' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderHealthStatusChart(allAnimals) {
            const canvas = document.getElementById('healthStatusChart');
            if (!canvas || !window.Chart) return;

            const totals = { Good: 0, Warning: 0, Danger: 0 };
            allAnimals.forEach(animal => {
                if (animal.health === 'good') totals.Good += 1;
                else if (animal.health === 'warning') totals.Warning += 1;
                else totals.Danger += 1;
            });

            if (healthStatusChartInstance) healthStatusChartInstance.destroy();
            healthStatusChartInstance = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: ['Good', 'Warning', 'Danger'],
                    datasets: [{
                        data: [totals.Good, totals.Warning, totals.Danger],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#64748b' } }
                    }
                }
            });
        }

        // Navigation
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function showSection(section) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.getElementById(section + '-section').classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const clickedItem = event?.currentTarget;
            if (clickedItem) clickedItem.classList.add('active');

            if (window.innerWidth < 1024) {
                document.getElementById('sidebar').classList.remove('open');
            }

            if (section === 'tracking') {
                initializeMap();
                setTimeout(() => mapInstance?.invalidateSize(), 150);
                renderTracking();
            }
        }

        function renderTrackingToolbar() {
            const toolbar = document.getElementById('trackingToolbar');
            if (!toolbar) return;
            const allAnimals = Object.values(animalDatabase).flat();

            const filters = Object.entries(trackingSpeciesMeta).map(([species, meta]) => {
                const count = allAnimals.filter(a => a.tracking.enabled && a.species === species).length;
                const active = trackingFilters.has(species);
                return `
                    <button class="tracking-filter ${active ? 'active' : ''}" onclick="toggleTrackingFilter('${species}')">
                        <span>${meta.icon}</span>
                        <span>${meta.label}</span>
                        <span class="filter-count">${count}</span>
                    </button>
                `;
            }).join('');

            toolbar.innerHTML = `
                <div class="tracking-filters">${filters}</div>
                <div class="tracking-view-toggle">
                    <button class="tracking-view-btn ${trackingViewMode === 'map' ? 'active' : ''}" onclick="setTrackingView('map')">Map View</button>
                    <button class="tracking-view-btn ${trackingViewMode === 'heat' ? 'active' : ''}" onclick="setTrackingView('heat')">Heat View</button>
                </div>
            `;
        }

        function initializeMap() {
            if (mapInstance) return;
            const mapElement = document.getElementById('trackingMap');
            if (!mapElement) return;

            const farmCenter = [3.1125, 101.7915];
            mapInstance = L.map('trackingMap', {
                zoomControl: false,
                attributionControl: false,
                minZoom: 16,
                maxZoom: 19
            }).setView(farmCenter, 17);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(mapInstance);

            const bounds = L.latLngBounds([3.108, 101.786], [3.118, 101.797]);
            mapInstance.setMaxBounds(bounds.pad(0.02));

            markerLayer = L.layerGroup().addTo(mapInstance);
            markerMap.clear();
            setTimeout(() => mapInstance.invalidateSize(), 200);
        }

        function renderTrackingStats(trackedAnimals) {
            const stats = document.getElementById('trackingStats');
            if (!stats) return;

            if (!trackedAnimals.length) {
                stats.innerHTML = `<div class="tracking-empty">Select a species to visualize activity on the map.</div>`;
                return;
            }

            const moving = trackedAnimals.filter(a => a.tracking.status === 'moving').length;
            const resting = trackedAnimals.length - moving;
            const alerts = trackedAnimals.filter(a => a.alerts.length > 0 || a.health !== 'good').length;
            const coverage = Math.round((trackingFilters.size / Object.keys(trackingSpeciesMeta).length) * 100);

            stats.innerHTML = `
                <div class="tracking-stat-card">
                    <div class="stat-label">Tracked Animals</div>
                    <div class="stat-value">${trackedAnimals.length}</div>
                    <div class="stat-meta">${moving} moving • ${resting} resting</div>
                </div>
                <div class="tracking-stat-card">
                    <div class="stat-label">Active Alerts</div>
                    <div class="stat-value">${alerts}</div>
                    <div class="stat-meta">${alerts ? 'Immediate attention required' : 'All clear'}</div>
                </div>
                <div class="tracking-stat-card">
                    <div class="stat-label">Filter Coverage</div>
                    <div class="stat-value">${coverage}%</div>
                    <div class="stat-meta">${trackingFilters.size} / ${Object.keys(trackingSpeciesMeta).length} species visible</div>
                </div>
            `;
        }

        function renderTrackingLegend(allAnimals) {
            const legendEl = document.getElementById('trackingLegend');
            if (!legendEl) return;
            const legendItems = Object.entries(trackingSpeciesMeta).map(([species, meta]) => {
                const count = allAnimals.filter(a => a.tracking.enabled && a.species === species).length;
                if (!count) return '';
                return `
                    <div class="legend-item">
                        <span class="legend-dot" style="background:${meta.color};"></span>
                        ${meta.icon} ${meta.label}
                        <span style="font-weight:800; margin-left:4px;">${count}</span>
                    </div>
                `;
            }).join('');

            legendEl.innerHTML = legendItems || '<div class="tracking-empty" style="margin:0;">No live devices reporting yet.</div>';
        }

        function buildAnimalIcon(animal) {
            const meta = trackingSpeciesMeta[animal.species] || {};
            const emoji = meta.icon || '🐾';
            const color = meta.color || '#6366f1';
            const html = `
                <div class="map-pin ${animal.tracking.status}" style="--pin-color:${color}" data-label="${animal.name}">
                    <div class="map-pin-inner">${emoji}</div>
                </div>
            `;
            return L.divIcon({
                className: 'map-pin-wrapper',
                html,
                iconSize: [48, 48],
                iconAnchor: [24, 24]
            });
        }

        function toggleTrackingFilter(species) {
            if (trackingFilters.has(species) && trackingFilters.size === 1) {
                showToast('At least one species must stay visible.');
                return;
            }

            if (trackingFilters.has(species)) {
                trackingFilters.delete(species);
            } else {
                trackingFilters.add(species);
            }

            mapNeedsFit = true;
            renderTracking();
            renderTrackingToolbar();
        }

        function setTrackingView(mode) {
            trackingViewMode = mode;
            renderTracking();
            renderTrackingToolbar();
        }

        function renderAlertsToolbar(allAlerts) {
            const toolbar = document.getElementById('alertsToolbar');
            if (!toolbar) return;

            const filterButtons = Object.entries(severityMeta).map(([severity, meta]) => {
                const count = allAlerts.filter(a => a.severity === severity).length;
                const active = alertFilters.has(severity);
                return `
                    <button class="alert-filter ${active ? 'active' : ''}" onclick="toggleAlertFilter('${severity}')">
                        <span>${meta.icon}</span>
                        <span>${meta.label}</span>
                        <span class="filter-count">${count}</span>
                    </button>
                `;
            }).join('');

            toolbar.innerHTML = `
                <div class="alert-filters">${filterButtons}</div>
                <div style="font-weight:700; color:var(--text-secondary);">Filters active: ${alertFilters.size}</div>
            `;
        }

        function renderAlertsSummary(allAlerts) {
            const summary = document.getElementById('alertsSummary');
            if (!summary) return;

            if (!allAlerts.length) {
                summary.innerHTML = `<div class="alerts-empty">No alerts in the queue. Monitoring in passive mode.</div>`;
                return;
            }

            const urgent = allAlerts.filter(a => a.severity === 'urgent').length;
            const moderate = allAlerts.filter(a => a.severity === 'moderate').length;
            const routine = allAlerts.filter(a => a.severity === 'routine').length;
            const critical = urgent + moderate;

            summary.innerHTML = `
                <div class="alert-summary-card">
                    <div class="label">Open Alerts</div>
                    <div class="value">${allAlerts.length}</div>
                    <div class="meta">${critical} requiring response</div>
                </div>
                <div class="alert-summary-card">
                    <div class="label">Severity Mix</div>
                    <div class="value">${urgent}/${moderate}/${routine}</div>
                    <div class="meta">Urgent / Moderate / Routine</div>
                </div>
                <div class="alert-summary-card">
                    <div class="label">Active Filters</div>
                    <div class="value">${alertFilters.size}</div>
                    <div class="meta">${Array.from(alertFilters).map(s => severityMeta[s].label).join(', ')}</div>
                </div>
            `;
        }

        function toggleAlertFilter(severity) {
            if (alertFilters.has(severity) && alertFilters.size === 1) {
                showToast('At least one severity must stay visible.');
                return;
            }

            if (alertFilters.has(severity)) {
                alertFilters.delete(severity);
            } else {
                alertFilters.add(severity);
            }

            renderAlerts();
        }

        function filterSpecies(species) {
            currentSpecies = species;
            document.querySelectorAll('.species-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderAnimals();
        }

        // Render animals grid
        function renderAnimals() {
            const grid = document.getElementById('animalsGrid');
            const animalList = animalDatabase[currentSpecies] || [];

            grid.innerHTML = animalList.map(animal => {
                const hasAlerts = animal.alerts.length > 0 || animal.health === 'danger';
                const devices = [];
                if (animal.sensors.heartRate) devices.push('❤️');
                if (animal.sensors.temp || animal.sensors.baskingTemp) devices.push('🌡️');
                if (animal.cctv) devices.push('📹');
                if (animal.tracking.enabled) devices.push('📍');
                if (animal.safety) devices.push('🔒');

                return `
                    <div class="animal-card ${hasAlerts ? 'has-alert' : ''}" onclick="openModal(${animal.id})">
                        <div class="animal-image-wrapper">
                            <img src="${animal.images[0]}" class="animal-image" alt="${animal.name}">
                            ${animal.tracking.enabled ? '<div class="tracking-badge live">LIVE TRACKING</div>' : ''}
                            <div class="health-badge ${animal.health}">
                                ${animal.health === 'good' ? '✓' : animal.health === 'warning' ? '⚠️' : '🔴'}
                            </div>
                        </div>
                        <div class="animal-content">
                            <div class="animal-header">
                                <div>
                                    <div class="animal-name">${animal.name}</div>
                                    <div class="animal-species">${animal.species}</div>
                                </div>
                            </div>
                            <div class="animal-stats">
                                <div class="stat-item">
                                    <div class="stat-item-label">Last Fed</div>
                                    <div class="stat-item-value">${animal.lastFed}</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-item-label">Health Status</div>
                                    <div class="stat-item-value">${animal.health.toUpperCase()}</div>
                                </div>
                            </div>
                            <div class="animal-devices">
                                ${devices.map(icon => `<div class="device-icon">${icon}</div>`).join('')}
                            </div>
                            <div class="animal-actions">
                                <button class="btn btn-primary">👁️ View Details</button>
                                <button class="btn btn-success" onclick="event.stopPropagation(); feedNow('${animal.name}')">🍽️ Feed</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Tracking simulation with realistic movement
        function startTrackingSimulation() {
            if (trackingUpdateInterval) clearInterval(trackingUpdateInterval);

            trackingUpdateInterval = setInterval(() => {
                const allAnimals = Object.values(animalDatabase).flat();
                allAnimals.forEach(animal => {
                    if (!animal.tracking.enabled) return;

                    if (animal.tracking.status === 'moving' &&
                        Number.isFinite(animal.tracking.lat) &&
                        Number.isFinite(animal.tracking.lng)) {
                        const centerLat = animal.tracking.center?.lat ?? animal.tracking.lat;
                        const centerLng = animal.tracking.center?.lng ?? animal.tracking.lng;
                        const radius = animal.tracking.radius ?? 0.0002;
                        const jitter = radius * 0.6;
                        animal.tracking.lat = clamp(centerLat + (Math.random() - 0.5) * jitter, centerLat - radius, centerLat + radius);
                        animal.tracking.lng = clamp(centerLng + (Math.random() - 0.5) * jitter, centerLng - radius, centerLng + radius);
                    }

                    if (Math.random() < (animal.tracking.status === 'moving' ? 0.025 : 0.05)) {
                            animal.tracking.status = animal.tracking.status === 'moving' ? 'resting' : 'moving';
                    }
                });

                if (document.getElementById('tracking-section').classList.contains('active')) {
                    renderTracking();
                }
            }, 4000);
        }

        // Render tracking map
        function renderTracking() {
            initializeMap();
            const mapCard = document.getElementById('mapCard');
            if (mapCard) {
                mapCard.classList.toggle('heat-mode', trackingViewMode === 'heat');
            }

            const allAnimals = Object.values(animalDatabase).flat();
            const trackedAnimals = allAnimals.filter(a => a.tracking.enabled && trackingFilters.has(a.species));

            renderTrackingLegend(allAnimals);
            renderTrackingStats(trackedAnimals);

            const listContainer = document.getElementById('trackingList');
            const emptyOverlay = document.getElementById('mapEmptyState');

            document.getElementById('trackedCount').textContent = trackedAnimals.length;

            if (listContainer) {
                if (!trackedAnimals.length) {
                    listContainer.innerHTML = `<div class="tracking-empty">No live trackers match the current filters.</div>`;
                } else {
                    listContainer.innerHTML = trackedAnimals.map(animal => `
                <div class="tracking-item" onclick="openModal(${animal.id})">
                    <img src="${animal.images[0]}" class="tracking-avatar" alt="${animal.name}">
                    <div class="tracking-info">
                        <div class="tracking-name">${animal.name}</div>
                        <div class="tracking-location">📍 ${animal.tracking.location}</div>
                        <div class="tracking-location">⏱️ Last fed ${animal.lastFed}</div>
                    </div>
                    <div class="tracking-status status-${animal.tracking.status}">
                        ${animal.tracking.status}
                    </div>
                </div>
            `).join('');
                }
            }

            if (!markerLayer || !mapInstance) {
                if (!trackedAnimals.length) {
                    emptyOverlay?.classList.remove('hidden');
                    mapNeedsFit = true;
                } else {
                    emptyOverlay?.classList.add('hidden');
                }
                return;
            }

            if (!trackedAnimals.length) {
                emptyOverlay?.classList.remove('hidden');
                mapNeedsFit = true;
                // remove markers if grid is empty
                markerMap.forEach(marker => markerLayer.removeLayer(marker));
                markerMap.clear();
                return;
            }

            emptyOverlay?.classList.add('hidden');

            const activeIds = new Set();
            const latLngs = [];
            trackedAnimals.forEach(animal => {
                if (!Number.isFinite(animal.tracking.lat) || !Number.isFinite(animal.tracking.lng)) return;
                const icon = buildAnimalIcon(animal);
                const position = [animal.tracking.lat, animal.tracking.lng];
                activeIds.add(animal.id);

                if (markerMap.has(animal.id)) {
                    const marker = markerMap.get(animal.id);
                    marker.setLatLng(position);
                    marker.setIcon(icon);
                } else {
                    const marker = L.marker(position, { icon });
                    marker.on('click', () => openModal(animal.id));
                    markerLayer.addLayer(marker);
                    markerMap.set(animal.id, marker);
                }

                latLngs.push(position);
            });

            markerMap.forEach((marker, id) => {
                if (!activeIds.has(id)) {
                    markerLayer.removeLayer(marker);
                    markerMap.delete(id);
                }
            });

            if (latLngs.length && mapNeedsFit) {
                const bounds = L.latLngBounds(latLngs).pad(0.18);
                mapInstance.flyToBounds(bounds, { duration: 0.6, maxZoom: 18 });
                mapNeedsFit = false;
            }
        }

        // Render feeding schedule
        function renderFeeding() {
            const grid = document.getElementById('feedingSchedule');
            grid.innerHTML = feedingSchedule.map(item => `
                <div class="schedule-item">
                    <div class="schedule-time">${item.icon} ${item.time}</div>
                    <div class="schedule-details">
                        <div class="schedule-animal">${item.animal}</div>
                        <div class="schedule-meal">${item.meal}</div>
                    </div>
                    <div class="schedule-status status-${item.status}">
                        ${item.status === 'completed' ? '✓ Completed' : '⏱️ Pending'}
                    </div>
                </div>
            `).join('');
        }

        // Render environment rooms
        function renderRooms() {
            const grid = document.getElementById('roomsGrid');
            grid.innerHTML = rooms.map(room => `
                <div class="room-card">
                    <div class="room-header">
                        <div class="room-name">${room.name}</div>
                        <div class="room-status ${room.status}"></div>
                    </div>
                    <div class="room-metrics">
                        <div class="metric">
                            <div class="metric-label">🌡️ Temperature</div>
                            <div class="metric-value">${room.temp}°C</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">💧 Humidity</div>
                            <div class="metric-value">${room.humidity}%</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">🌬️ Air Quality</div>
                            <div class="metric-value">${room.aqi} AQI</div>
                        </div>
                    </div>
                    <div class="temp-control">
                        <button class="temp-btn" onclick="adjustTemp(${room.id}, -1)">−</button>
                        <div class="temp-slider">
                            <div class="temp-slider-fill" style="width: ${(room.temp / 35) * 100}%"></div>
                        </div>
                        <button class="temp-btn" onclick="adjustTemp(${room.id}, 1)">+</button>
                    </div>
                </div>
            `).join('');
        }

        // Render inventory
        function renderInventory() {
            const grid = document.getElementById('inventoryGrid');
            grid.innerHTML = inventory.map(item => `
                <div class="inventory-item">
                    <div class="inventory-icon">${item.icon}</div>
                    <div class="inventory-details">
                        <div class="inventory-name">${item.name}</div>
                        <div class="inventory-category">${item.category}</div>
                    </div>
                    <div class="inventory-stock">
                        <div class="stock-level">${item.stock}</div>
                        <div class="stock-status ${item.stock < item.min ? 'stock-low' : 'stock-ok'}">
                            ${item.stock < item.min ? 'Low Stock' : 'In Stock'}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Render alerts
        function renderAlerts() {
            const allAnimals = Object.values(animalDatabase).flat();
            const alerts = [];

            allAnimals.forEach(animal => {
                animal.alerts.forEach(alertText => {
                    const severity = animal.health === 'danger' ? 'urgent' : 'moderate';
                    alerts.push({
                        severity,
                        message: alertText,
                        animal: `${animal.name} (${animal.species})`,
                        time: 'Just now',
                        animalId: animal.id,
                        location: animal.tracking?.location || 'Habitat floor',
                        health: animal.health,
                        requiresAction: severity !== 'routine'
                    });
                });
            });

            // Add routine alerts
            alerts.push({
                severity: 'routine',
                message: 'Fox vaccination due next week',
                animal: 'Foxes',
                time: 'Today',
                location: 'Clinic dashboard',
                requiresAction: false
            });

            renderAlertsToolbar(alerts);
            renderAlertsSummary(alerts);

            const visibleAlerts = alerts.filter(alert => alertFilters.has(alert.severity));

            const grid = document.getElementById('alertsGrid');
            if (!visibleAlerts.length) {
                grid.innerHTML = `<div class="alerts-empty">No alerts match the current filters.</div>`;
                return;
            }

            grid.innerHTML = visibleAlerts.map(alert => {
                const meta = severityMeta[alert.severity] || {};
                return `
                <div class="alert-item ${alert.severity}">
                    <div class="alert-header">
                            <span class="alert-pill ${alert.severity}">${meta.icon || 'ℹ️'} ${meta.label || alert.severity}</span>
                            <span class="alert-time">${alert.time}</span>
                    </div>
                    <div class="alert-message">${alert.message}</div>
                    <div class="alert-animal">${alert.animal}</div>
                        <div class="alert-meta">
                            <span class="alert-tag">📍 ${alert.location || 'Shelter grounds'}</span>
                            <span class="alert-tag">❤️ Status: ${alert.health ? alert.health.toUpperCase() : 'OK'}</span>
                        </div>
                        <div class="alert-progress">
                            <div class="alert-progress-fill" style="--progress:${meta.progress || '60%'}"></div>
                        </div>
                    ${alert.animalId ? `
                        <div class="alert-actions">
                            <button class="btn btn-primary" onclick="openModal(${alert.animalId})">View Details</button>
                            <button class="btn btn-success" onclick="acknowledgeAlert(this)">Acknowledge</button>
                        </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        // Modal functions
        function openModal(id) {
            const allAnimals = Object.values(animalDatabase).flat();
            const animal = allAnimals.find(a => a.id === id);
            if (!animal) return;

            selectedAnimal = animal;
            document.getElementById('modalTitle').textContent = animal.name;
            document.getElementById('modalSubtitle').textContent = animal.species;
            document.getElementById('modalImage').src = animal.images[0];

            // Emergency panel for dangerous animals
            const emergencyPanel = document.getElementById('emergencyPanel');
            if (animal.safety) {
                emergencyPanel.innerHTML = `
                    <div class="emergency-panel">
                        <div class="emergency-title">⚠️ Safety Controls</div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-danger" onclick="emergencyLock()">🔒 Emergency Lock</button>
                            <button class="btn btn-danger" onclick="supervisorAlert()">📢 Alert Supervisor</button>
                        </div>
                    </div>
                `;
            } else {
                emergencyPanel.innerHTML = '';
            }

            // CCTV feed display
            const cctvFeed = document.getElementById('cctvFeed');
            if (!animal.cctv) {
                cctvFeed.style.display = 'none';
            } else {
                cctvFeed.style.display = 'block';
            }

            // Sensors
            let sensorsHtml = '';
            Object.entries(animal.sensors).forEach(([key, sensor]) => {
                sensorsHtml += `
                    <div class="sensor-card">
                        <div class="sensor-icon">${sensor.icon}</div>
                        <div class="sensor-label">${sensor.label}</div>
                        <div class="sensor-value">${sensor.value}${sensor.unit}</div>
                    </div>
                `;
            });
            document.getElementById('modalSensors').innerHTML = sensorsHtml;

            // Notes
            document.getElementById('modalNotes').innerHTML = animal.notes.map(n =>
                `<div class="note-item"><span class="note-time">${n.time}:</span> ${n.text}</div>`
            ).join('');

            document.getElementById('animalModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('animalModal').classList.remove('active');
        }

        // Actions
        function feedNow(name) {
            showToast(`✅ ${name} has been fed successfully!`);
            setTimeout(() => {
                updateDashboardStats();
                renderAnimals();
            }, 500);
        }

        function feedAnimal() {
            if (selectedAnimal) {
                showToast(`✅ ${selectedAnimal.name} has been fed!`);
                closeModal();
                setTimeout(() => {
                    updateDashboardStats();
                    renderAnimals();
                }, 500);
            }
        }

        function adjustTemp(id, delta) {
            const room = rooms.find(r => r.id === id);
            if (room) {
                room.temp += delta;
                room.temp = Math.max(15, Math.min(35, room.temp));

                // Update status based on target
                const diff = Math.abs(room.temp - room.target);
                room.status = diff > 3 ? 'danger' : diff > 1 ? 'warning' : 'good';

                renderRooms();
                showToast(`${room.name} temperature adjusted to ${room.temp}°C`);
            }
        }

        function emergencyLock() {
            showToast(`🔒 Emergency lock activated for ${selectedAnimal.name}'s enclosure`);
        }

        function supervisorAlert() {
            showToast(`📢 Supervisor has been alerted about ${selectedAnimal.name}`);
        }

        function acknowledgeAlert(btn) {
            btn.closest('.alert-item').style.opacity = '0.5';
            showToast('✅ Alert acknowledged');
            setTimeout(() => {
                btn.closest('.alert-item').remove();
                updateDashboardStats();
            }, 500);
        }

        function clamp(value, min, max) {
            return Math.max(min, Math.min(max, value));
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Close modal on outside click
        document.getElementById('animalModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>
